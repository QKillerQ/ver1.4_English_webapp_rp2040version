<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIDtaiko RP2040 English Interface</title>
    <link rel="icon" href="img/favicon.ico">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24, #6c5ce7, #fd79a8, #fdcb6e, #e17055);
            background-size: 400% 400%;
            animation: tiedye 15s ease infinite;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }

        @keyframes tiedye {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header .subtitle {
            color: #718096;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .status-info {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 5px solid #4299e1;
        }

        .connection-panel {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #4299e1;
        }

        .button-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(66, 153, 225, 0.4);
        }

        .btn.save {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn.save:hover {
            box-shadow: 0 6px 18px rgba(72, 187, 120, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.4;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .status {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            background: #fed7d7;
            color: #c53030;
            display: block;
            text-align: center;
            width: 100%;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .drum-row {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .slider-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .slider-container.surface {
            border-left: 4px solid #e53e3e;
        }

        .slider-container.surface .slider-value {
            background: #e53e3e;
        }

        .slider-container.surface input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .slider-container.surface input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .slider-container.compact {
            flex: 1;
            padding: 15px;
            min-width: 200px;
        }

        .slider-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .slider-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1em;
        }

        .drum-label {
            font-size: 0.9em;
            color: #718096;
            font-style: italic;
        }

        .slider-value {
            background: #4299e1;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .slider-description {
            font-size: 10px;
            color: #666;
            margin: 8px 0 0 0;
            line-height: 1.3;
            opacity: 0.8;
            font-style: italic;
            padding: 0 4px;
        }

        .slider-container:hover .slider-description {
            opacity: 1;
            color: #444;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(90deg, #e2e8f0 0%, #4299e1 0%);
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .instructions {
            background: #edf2f7;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #38a169;
        }

        .instructions h2 {
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            color: #4a5568;
            line-height: 1.6;
        }

        .parameter-help {
            background: #f0fff4;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #68d391;
        }

        .parameter-help h3 {
            color: #22543d;
            margin-top: 0;
        }

        .parameter-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .parameter-item strong {
            color: #2d3748;
            display: block;
            margin-bottom: 5px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .footer a {
            color: #4299e1;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .button-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .drum-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HIDtaiko RP2040 Controller</h1>
            <div class="subtitle">English Interface - Real-time Sensitivity & Timing Configuration</div>
        </div>

        <div class="status-info">
            <span id="status" class="status">No device connected</span>
        </div>

        <div class="connection-panel">
            <div class="button-row">
                <button id="connect" class="btn">Connect</button>
                <button id="disconnect" class="btn" disabled>Disconnect</button>
                <button id="sendButton" class="btn" disabled>Send Settings</button>
                <button id="requestButton" class="btn" disabled>Request Settings</button>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Drum Pad Sensitivity (Lower = More Sensitive)</h2>
            
            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">A3 - Left Rim</div>
                        <div class="drum-label">Outer edge, left side</div>
                    </div>
                    <span id="valueDx3" class="slider-value">80</span>
                </div>
                <input type="range" min="0" max="500" step="5" value="80" id="dx3"/>
                <p class="slider-description">Threshold for left rim sensor. Lower values = more sensitive.</p>
            </div>

            <div class="slider-container surface">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">A2 - Left Surface</div>
                        <div class="drum-label">Main drum surface, left side</div>
                    </div>
                    <span id="valueDx2" class="slider-value">130</span>
                </div>
                <input type="range" min="0" max="500" step="5" value="130" id="dx2"/>
                <p class="slider-description">Threshold for left surface sensor. Lower values = more sensitive.</p>
            </div>

            <div class="slider-container surface">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">A1 - Right Surface</div>
                        <div class="drum-label">Main drum surface, right side</div>
                    </div>
                    <span id="valueDx1" class="slider-value">130</span>
                </div>
                <input type="range" min="0" max="500" step="5" value="130" id="dx1"/>
                <p class="slider-description">Threshold for right surface sensor. Lower values = more sensitive.</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">A0 - Right Rim</div>
                        <div class="drum-label">Outer edge, right side</div>
                    </div>
                    <span id="valueDx0" class="slider-value">80</span>
                </div>
                <input type="range" min="0" max="500" step="5" value="80" id="dx0"/>
                <p class="slider-description">Threshold for right rim sensor. Lower values = more sensitive.</p>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Input Delay Timers (milliseconds)</h2>
            
            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">Delay Setting #1 - Same Pad Lockout</div>
                        <div class="drum-label">Time before same pad can trigger again</div>
                    </div>
                    <span id="valueDx8" class="slider-value">1</span>
                </div>
                <input type="range" min="1" max="50" step="1" value="1" id="dx8"/>
                <p class="slider-description">Prevents double-hits on same pad. Increase if getting unwanted double-hits.</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">Delay Setting #2 - Surface Pad Lockout</div>
                        <div class="drum-label">Surface pad lockout after any hit</div>
                    </div>
                    <span id="valueDx4" class="slider-value">10</span>
                </div>
                <input type="range" min="1" max="80" step="1" value="10" id="dx4"/>
                <p class="slider-description">Surface pad lockout after any hit. Don't set too high or rapid hits won't register.</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">Delay Setting #3 - Rim Pad Lockout</div>
                        <div class="drum-label">Rim pad lockout after any hit</div>
                    </div>
                    <span id="valueDx5" class="slider-value">30</span>
                </div>
                <input type="range" min="1" max="80" step="1" value="30" id="dx5"/>
                <p class="slider-description">Rim pad lockout after any hit. Similar to Setting #2 but for rim pads.</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">Delay Setting #4 - Cross Lockout</div>
                        <div class="drum-label">Cross-lockout between surface and rim</div>
                    </div>
                    <span id="valueDx6" class="slider-value">32</span>
                </div>
                <input type="range" min="1" max="80" step="1" value="32" id="dx6"/>
                <p class="slider-description">Prevents rim triggering when surface is hit and vice versa.</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <div>
                        <div class="slider-label">Delay Setting #5 - Hold Adjustment</div>
                        <div class="drum-label">Compatibility for rhythm games (usually 0 or 20)</div>
                    </div>
                    <span id="valueDx7" class="slider-value">0</span>
                </div>
                <input type="range" min="0" max="80" step="1" value="0" id="dx7"/>
                <p class="slider-description">Special timing for rhythm games. Use 0 for most games, try 20 if issues occur.</p>
            </div>
        </div>

        <div class="instructions">
            <h2>Setup Instructions</h2>
            <ol>
                <li><strong>Click "Connect"</strong> and select your HIDtaiko device (Chrome/Edge browser required)</li>
                <li><strong>Click "Request Settings"</strong> to load current values from controller</li>
                <li><strong>Adjust sliders</strong> - Changes are sent in real-time</li>
                <li><strong>Use "Send Settings"</strong> to manually update controller if needed</li>
            </ol>
            <p><em>Note: Sensitivity values are thresholds - lower numbers = higher sensitivity</em></p>
        </div>

        <div class="parameter-help">
            <h3>Parameter Guide</h3>
            
            <div class="parameter-item">
                <strong>Sensitivity:</strong>
                Threshold values for piezo sensors. When sensor voltage exceeds this value, a key press is triggered. Lower values = more sensitive.
            </div>
            
            <div class="parameter-item">
                <strong>Delay Setting #1:</strong>
                Prevents the same pad from triggering multiple times rapidly. Increase if you get unwanted double-hits on the same pad.
            </div>
            
            <div class="parameter-item">
                <strong>Delay Setting #2:</strong>
                Lockout time for surface pads after any pad is hit. Prevents multiple surface hits but don't set too high or rapid surface hits won't register.
            </div>
            
            <div class="parameter-item">
                <strong>Delay Setting #3:</strong>
                Lockout time for rim pads after any pad is hit. Similar to Delay Setting #2 but for rim pads.
            </div>
            
            <div class="parameter-item">
                <strong>Delay Setting #4:</strong>
                Cross-lockout between surface and rim pads. Prevents rim from triggering when surface is hit and vice versa.
            </div>
            
            <div class="parameter-item">
                <strong>Delay Setting #5:</strong>
                Special timing adjustment for certain rhythm games. Use 0 for most games, try 20 if controller works in text editors but not in games.
            </div>
        </div>

        <div class="footer">
            <p><strong>HIDtaiko RP2040 English Interface</strong></p>
            <p>Enhanced English version with modern UI</p>
            <p>Based on original work by <a href="https://github.com/kasasiki3" target="_blank">kasasiki3</a></p>
        </div>
    </div>

    <script>
        // Global variables (make sure these are let, not const)
        let port = null;
        let writer = null;
        let reader = null;
        let isConnected = false;

        // Get UI elements
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const sendBtn = document.getElementById('sendButton');
        const requestBtn = document.getElementById('requestButton');
        const statusDisplay = document.getElementById('status');

        // Slider mappings to match original Japanese interface
        const sliders = {
            dx0: document.getElementById('dx0'),
            dx1: document.getElementById('dx1'),
            dx2: document.getElementById('dx2'),
            dx3: document.getElementById('dx3'),
            dx4: document.getElementById('dx4'),
            dx5: document.getElementById('dx5'),
            dx6: document.getElementById('dx6'),
            dx7: document.getElementById('dx7'),
            dx8: document.getElementById('dx8')
        };

        const valueDisplays = {
            dx0: document.getElementById('valueDx0'),
            dx1: document.getElementById('valueDx1'),
            dx2: document.getElementById('valueDx2'),
            dx3: document.getElementById('valueDx3'),
            dx4: document.getElementById('valueDx4'),
            dx5: document.getElementById('valueDx5'),
            dx6: document.getElementById('valueDx6'),
            dx7: document.getElementById('valueDx7'),
            dx8: document.getElementById('valueDx8')
        };

        // Update slider background visual
        function updateSliderBackground(slider) {
            const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.background = `linear-gradient(90deg, #4299e1 ${value}%, #e2e8f0 ${value}%)`;
        }

        // Initialize all sliders
        Object.values(sliders).forEach(slider => {
            updateSliderBackground(slider);
            slider.addEventListener('input', function() {
                const key = Object.keys(sliders).find(k => sliders[k] === this);
                valueDisplays[key].textContent = this.value;
                updateSliderBackground(this);
                if (isConnected) {
                    sendCurrentValues();
                }
            });
        });

        // Web Serial API Connection
        async function connectDevice() {
            console.log('Connect button clicked - starting Web Serial connection...');
            
            if (!navigator.serial) {
                statusDisplay.textContent = 'Web Serial not supported in this browser';
                console.error('Web Serial not supported');
                return;
            }
            
            try {
                const serialPort = await navigator.serial.requestPort({
                    filters: []
                });
                
                console.log('Device selected, attempting to open...');
                
                // Try with more flexible settings
                await serialPort.open({
                    baudRate: 9600,  // Try slower rate first
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none',
                    bufferSize: 255
                });
                
                console.log('Serial port opened successfully!');
                
                writer = serialPort.writable.getWriter();
                
                const decoder = new TextDecoderStream();
                serialPort.readable.pipeTo(decoder.writable);
                reader = decoder.readable.getReader();
                
                // Fix: Don't reassign port, just update the global variables
                port = serialPort;
                isConnected = true;
                
                statusDisplay.textContent = 'Connected to HIDtaiko RP2040 (Serial)';
                statusDisplay.className = 'status connected';
                
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                requestBtn.disabled = false;
                
                readLoop();
                
                console.log('HIDtaiko connected successfully via Serial!');
                
            } catch (error) {
                console.error('Connection failed:', error);
                let errorMessage = 'Connection failed';
                if (error.name === 'NotFoundError') {
                    errorMessage = 'No HIDtaiko device selected. Please select your HIDtaiko device.';
                } else {
                    errorMessage = `Connection failed: ${error.message}`;
                }
                statusDisplay.textContent = errorMessage;
                statusDisplay.className = 'status';
            }
        }

        async function disconnectDevice() {
            isConnected = false;
            
            if (reader) {
                try {
                    await reader.cancel();
                    reader.releaseLock();
                } catch (error) {
                    console.error('Reader close error:', error);
                }
                reader = null;
            }
            
            if (writer) {
                try {
                    writer.releaseLock();
                } catch (error) {
                    console.error('Writer close error:', error);
                }
                writer = null;
            }
            
            if (port) {
                try {
                    await port.close();
                } catch (error) {
                    console.error('Port close error:', error);
                }
                port = null;
            }
            
            statusDisplay.textContent = 'Disconnected';
            statusDisplay.className = 'status';
            
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            sendBtn.disabled = true;
            requestBtn.disabled = true;
        }

        async function readLoop() {
            if (!port || !isConnected || !reader) return;
            
            try {
                while (isConnected && reader) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value && value.trim()) {
                        console.log('Received from device:', value.trim());
                        
                        // Try to parse any response from device
                        parseReceivedData(value);
                        
                        // Show raw data in status for debugging
                        statusDisplay.textContent = `Data received: ${value.trim().substring(0, 50)}...`;
                    }
                }
            } catch (error) {
                if (isConnected) {
                    console.error('Read error:', error);
                }
            }
        }

        function parseReceivedData(data) {
            console.log('Parsing received data:', data);
            
            try {
                // The device might send binary data back - let's handle both
                if (typeof data === 'string') {
                    // Text data
                    const lines = data.trim().split('\n');
                    console.log('Split into lines:', lines);
                    
                    const values = [];
                    for (const line of lines) {
                        const cleaned = line.trim();
                        if (cleaned && !isNaN(cleaned)) {
                            values.push(parseInt(cleaned));
                        }
                    }
                    
                    console.log('Extracted values:', values);
                    
                    if (values.length >= 9) {
                        updateSlidersWithValues(values);
                    }
                } else {
                    // Binary data - convert to array
                    const values = Array.from(new Uint8Array(data));
                    console.log('Binary values received:', values);
                    
                    if (values.length >= 9) {
                        updateSlidersWithValues(values);
                    }
                }
            } catch (error) {
                console.error('Parse error:', error);
            }
        }
        
        function updateSlidersWithValues(values) {
            console.log('Updating sliders with values:', values);
            
            // Map to sliders: [A1, A0, A2, A3, B, C, D, H, A] based on original order
            const mapping = ['dx1', 'dx0', 'dx2', 'dx3', 'dx4', 'dx5', 'dx6', 'dx7', 'dx8'];
            
            values.slice(0, 9).forEach((value, index) => {
                if (mapping[index] && sliders[mapping[index]]) {
                    console.log(`Setting ${mapping[index]} to ${value}`);
                    sliders[mapping[index]].value = value;
                    valueDisplays[mapping[index]].textContent = value;
                    updateSliderBackground(sliders[mapping[index]]);
                }
            });
            
            statusDisplay.textContent = 'Settings loaded from device successfully!';
            statusDisplay.className = 'status connected';
        }

        async function sendCurrentValues() {
            if (!port || !isConnected || !writer) return;
            
            try {
                console.log('Sending values (binary format)...');
                
                // Send as binary data like the original Japanese interface
                const values = new Uint8Array([
                    parseInt(sliders.dx1.value), // A1 - Right Surface
                    parseInt(sliders.dx0.value), // A0 - Right Rim  
                    parseInt(sliders.dx2.value), // A2 - Left Surface
                    parseInt(sliders.dx3.value), // A3 - Left Rim
                    parseInt(sliders.dx4.value), // B-delay
                    parseInt(sliders.dx5.value), // C-delay
                    parseInt(sliders.dx6.value), // D-delay
                    parseInt(sliders.dx7.value), // H-delay
                    parseInt(sliders.dx8.value)  // A-delay
                ]);
                
                console.log('Sending binary values:', Array.from(values));
                
                // Send as raw binary data
                await writer.write(values);
                
                console.log('Binary values sent successfully');
                statusDisplay.textContent = 'Settings sent to device (binary)';
                
            } catch (error) {
                console.error('Send error:', error);
                statusDisplay.textContent = 'Send failed: ' + error.message;
            }
        }

        async function requestValues() {
            if (!port || !isConnected || !writer) return;
            
            try {
                console.log('Requesting values (binary format)...');
                
                // Send request command as binary (like original interface)
                const requestCommand = new Uint8Array([255]); // 255 = request command
                
                await writer.write(requestCommand);
                console.log('Binary request sent');
                statusDisplay.textContent = 'Requested settings from device (binary)';
                
            } catch (error) {
                console.error('Request error:', error);
                statusDisplay.textContent = 'Request failed: ' + error.message;
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectDevice);
        disconnectBtn.addEventListener('click', disconnectDevice);
        sendBtn.addEventListener('click', sendCurrentValues);
        requestBtn.addEventListener('click', requestValues);

        // Check for Web Serial API support
        if (!navigator.serial) {
            statusDisplay.textContent = 'Web Serial not supported. Use Chrome 89+ or Edge 89+.';
            statusDisplay.className = 'status';
            connectBtn.disabled = true;
        } else {
            statusDisplay.textContent = 'Ready to connect (Web Serial API)';
            statusDisplay.className = 'status';
        }
    </script>
</body>
</html>
